# Feature Request

## üìã Feature Description

Implement a minimal corporate authentication MVP for the API. The feature should provide secure user authentication and basic account recovery flows while preparing the codebase for future ACL expansion.

Core capabilities:

- Login with email and password
- Logout (token invalidation strategy for future work)
- Password reset flow (request + reset)
- Logged-in user profile endpoint
- Preparation for role-based access control (roles such as admin, user)

## üéØ Feature Type

- [x] üîê **Authentication/Authorization** - Auth-related features

## üí° Problem Statement

Many API endpoints require authenticated access, but the project currently lacks a consolidated authentication module implementing modern best practices (JWT, DTO validation, secure password hashing, and account recovery flows). Implementing a minimal, well-tested auth module will standardize authentication across the project and provide a foundation for ACL and security improvements.

### Current Situation

- Project stack: NestJS + Prisma + bcrypt. There is no centralized auth module with JWT-based protection and password reset flow documented/implemented as a cohesive feature.

### Proposed Solution

Create an `auth` module under `src/modules/auth` that implements JWT-based authentication using `@nestjs/jwt` and `passport-jwt`, DTO-based validation, bcrypt password hashing, and endpoints for login, logout, request-reset and reset-password. Expose a protected `GET /auth/profile` endpoint returning the current user's profile. Keep the implementation minimal for MVP while following project conventions (technical English, tests, linting, and formatting).

## üé® Feature Requirements

### Functional Requirements

- [ ] POST `/auth/login` ‚Äî accepts email and password, returns JWT and user profile
- [ ] POST `/auth/logout` ‚Äî accepts token (or rely on client discard for MVP) and returns success
- [ ] POST `/auth/request-reset` ‚Äî accepts email and returns a reset token (MVP: token returned in response)
- [ ] POST `/auth/reset-password` ‚Äî accepts reset token and new password, updates user password
- [ ] GET `/auth/profile` ‚Äî protected endpoint returning the logged-in user's profile
- [ ] Passwords stored hashed with bcrypt
- [ ] DTO validation (`class-validator`) for all incoming payloads

### Non-Functional Requirements

- [ ] Follow project coding standards (technical English in files, linting, Prettier)
- [ ] Unit tests for service logic and guards (target: include happy path + edge cases)
- [ ] E2E tests for auth flows (login, profile access, reset flow)
- [ ] No secrets committed; use environment variables for JWT secret and expiry

## üìê Technical Specifications

### API Design

#### POST /auth/login

Request example:

```json
{
  "email": "user@example.com",
  "password": "secret"
}
```

Response (200):

```json
{
  "access_token": "<jwt>",
  "user": { "id": 1, "name": "...", "email": "...", "role": "user" }
}
```

#### POST /auth/logout

Request example (MVP):

```json
{ "token": "<jwt>" }
```

> Note: For MVP, client-side token discard is acceptable. A server-side blacklist or refresh-token flow is recommended for production.

#### POST /auth/request-reset

Request example:

```json
{ "email": "user@example.com" }
```

Response (MVP):

```json
{ "message": "Token generated", "token": "<reset-token>" }
```

#### POST /auth/reset-password

Request example:

```json
{ "token": "<reset-token>", "newPassword": "newSecret" }
```

#### GET /auth/profile

Headers: `Authorization: Bearer <jwt>`

### Database Changes

- The existing `User` model must contain at least: `id`, `email` (unique), `password` (hashed), `name`, `role`, and `isActive`.
- For MVP the reset tokens may be held in-memory or in a transient table; production must use persistent storage and email delivery.

Example note for Prisma schema (verify existing schema before changes):

```prisma
model User {
  id        Int     @id @default(autoincrement())
  email     String  @unique
  password  String
  name      String?
  role      String  @default("user")
  isActive  Boolean @default(true)
  // other fields...
}
```

### Dependencies

- `@nestjs/jwt`
- `@nestjs/passport`
- `passport`
- `passport-jwt`
- `@types/passport-jwt` (dev)

Install commands:

```bash
pnpm add @nestjs/jwt @nestjs/passport passport passport-jwt
pnpm add -D @types/passport-jwt
```

## üß™ Acceptance Criteria

### Core Functionality

- [ ] Login endpoint authenticates valid credentials and returns JWT
- [ ] Profile endpoint is protected and returns current user (no password field)
- [ ] Password reset flow (request + reset) completes successfully for a test user
- [ ] Passwords are stored hashed (bcrypt)

### Quality Assurance

- [ ] Unit tests cover service methods (login, reset flow, profile retrieval)
- [ ] E2E tests validate the full authentication workflow
- [ ] Code follows linting and formatting rules; pre-commit hooks pass
- [ ] Documentation updated: README or docs/wiki links to auth module (via controlled docs workflow)

### Security & Performance

- [ ] JWT secret and expiry configured via environment variables (e.g., `JWT_SECRET`, `JWT_EXPIRES_IN`)
- [ ] No secret values in the repository
- [ ] Rate limiting considered for endpoints (future iteration)

## üì∏ Mockups / Examples

N/A

## üîó Related Issues

- Depends on: #issue-number (if applicable)

## üöÄ Implementation Notes

### Development Approach

1. Create `src/modules/auth` with controller, service, module, DTOs, `jwt.strategy`, and `jwt.guard`. Use Nest CLI when generating files where applicable.
2. Implement `AuthService` using `UsersService` for lookups and updates. Use bcrypt for hashing/comparing passwords.
3. Register `JwtModule` with `process.env.JWT_SECRET` and `process.env.JWT_EXPIRES_IN`.
4. Add unit tests and E2E tests under the existing `test/` structure.
5. Run formatting and linting before committing: `pnpm format` and `pnpm run lint`.

### Technical Considerations

- For MVP the reset token may be ephemeral (in-memory map). For production, implement email delivery and persistent tokens with expiry.
- Keep tokens short-lived and consider refresh token flow in next iterations.
- Do not commit environment secrets. Use `.env` and CI secret management.

### Breaking Changes

- [ ] **No breaking changes** expected for existing public APIs. If User model changes are required, add migration and document migration steps.

## üéØ Priority

- [x] üü° **High** - Important for next release (authentication is required for protected endpoints)

## üìÖ Timeline

- **Target Release**: v0.1.0
- **Estimated Effort**: 2‚Äì5 days (implementation + tests)

## üìù Additional Context

This request was converted from an internal planning note describing a minimal corporate authentication MVP. It focuses on secure, testable, and extensible implementation with clear acceptance criteria and next steps for production hardening (refresh tokens, blacklist, email delivery, ACL).
